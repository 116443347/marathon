<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Marathon: Blue-Green Deployment</title>
    <link rel="icon" type="image/x-icon" href="/marathon/img/marathon-favicon.ico">
    <link href="//cdn.jsdelivr.net/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/marathon/css/style.css" rel="stylesheet">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-45222428-4', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/marathon/">Marathon</a>
              </div>
              <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                  <li class="active">
                    <a href="/marathon/docs/">Docs</a>
                  </li>
                  <li >
                    <a href="/marathon/resources.html">Resources</a>
                  </li>
                  <li >
                    <a href="/marathon/support.html">Support</a>
                  </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                  <li><a href="https://github.com/mesosphere/marathon">GitHub</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">
    <div class="col-sm-3">

        <h5>Getting Started</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/">
                    Install Marathon
                </a>
            </li>
            <li>
                <a href="/marathon/docs/setup.html">
                    Setup Recommendations
                </a>
            </li>
            <li>
                <a href="/marathon/docs/high-availability.html">
                    High Availability Mode
                </a>
            </li>
        </ul>

        <h5>Using Marathon</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/application-basics.html">
                    Application Basics
                </a>
            </li>
            <li>
                <a href="/marathon/docs/deployments.html">
                    Application Deployments
                </a>
            </li>
            <li>
                <a href="/marathon/docs/application-groups.html">
                    Application Groups
                </a>
            </li>
            <li>
                <a href="/marathon/docs/artifact-store.html">
                    Artifact Store
                </a>
            </li>
            <li>
                <a href="/marathon/docs/auth-access-ctrl.html">
                    Authorization and Access Control
                </a>
            </li>
            <li>
                <a href="/marathon/docs/blue-green-deploy.html">
                    Blue-Green Deployment
                </a>
            </li>
            <li>
                <a href="/marathon/docs/constraints.html">
                    Constraints
                </a>
            </li>
            <li>
                <a href="/marathon/docs/event-bus.html">
                    Event Bus
                </a>
            </li>
            <li>
                <a href="/marathon/docs/health-checks.html">
                    Health Checks
                </a>
            </li>
            <li>
                <a href="/marathon/docs/ip-per-task.html">
                    IP-per-task
                </a>
            </li>
            <li>
                <a href="/marathon/docs/marathon-ui.html">
                    Marathon Web Interface
                </a>
            </li>
            <li>
                <a href="/marathon/docs/ports.html">
                    Ports
                </a>
            </li>
            <li>
                <a href="/marathon/docs/recipes.html">
                    Recipes
                </a>
            </li>
            <li>
                <a href="/marathon/docs/native-docker.html">
                    Running Docker Containers
                </a>
            </li>
            <li>
                <a href="/marathon/docs/persistent-volumes.html">
                    Stateful Applications Using Local Persistent Volumes
                </a>
            </li>
            <li>
                <a href="/marathon/docs/external-volumes.html">
                    Stateful Applications Using External Persistent Volumes
                </a>
            </li>
            <li>
                <a href="/marathon/docs/task-environment-vars.html">
                    Task Environment Variables
                </a>
            </li>
        </ul>

        <h5>Administration</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/command-line-flags.html">
                    Command Line Flags
                </a>
            </li>
            <li>
                <a href="/marathon/docs/framework-authentication.html">
                    Framework Authentication
                </a>
            </li>
            <li>
                <a href="/marathon/docs/high-availability.html">
                    High Availability
                </a>
            </li>
            <li>
                <a href="/marathon/docs/metrics.html">
                    Metrics
                </a>
            </li>
            <li>
                <a href="/marathon/docs/readiness-checks.html">
                    Readiness Checks
                </a>
            </li>
            <li>
                <a href="/marathon/docs/service-discovery-load-balancing.html">
                    Service Discovery and Load Balancing
                </a>
            </li>
            <li>
                <a href="/marathon/docs/ssl-basic-access-authentication.html">
                    SSL and Basic Authentication
                </a>
            </li>
            <li>
                <a href="/marathon/docs/upgrade/index.html">
                    Upgrading
                </a>
            </li>
            <li>
                <a href="/marathon/docs/upgrade/06xto070.html">
                    Upgrading from 0.6.x
                </a>
            </li>
            <li>
                <a href="/marathon/docs/native-docker-private-registry.html">
                    Using a Private Docker Registry
                </a>
            </li>
            <li>
                <a href="/marathon/docs/upgrade/versioning.html">
                    Versioning
                </a>
            </li>
        </ul>

        <h5>Troubleshooting</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/waiting.html">
                    An App Does Not Leave "Waiting"
                </a>
            </li>
            <li>
                <a href="/marathon/docs/host-port.html">
                    An App Requires a Specific Host Port
                </a>
            </li>
            <li>
                <a href="/marathon/docs/local-cert.html">
                    Error Using HTTPS with local CA Certificate
                </a>
            </li>
            <li>
                <a href="/marathon/docs/auth-secret.html">
                    Error Reading Authentication Secret
                </a>
            </li>
        </ul>

        <h5>Development</h5>
        <ul class="list-unstyled">
            <li>
                <a href="/marathon/docs/contributing.html">
                    Contributor Guidelines
                </a>
            </li>
            <li>
                <a href="/marathon/docs/core-architecture.html">
                    Current Marathon Development
                </a>
            </li>
            <li>
                <a href="/marathon/docs/plugin.html">
                    Extend Marathon with Plugins
                </a>
            </li>
            <li>
                <a href="/marathon/docs/developing-vm.html">
                    Run a Local Version of Marathon
                </a>
            </li>
        </ul>

        <h5>API Reference</h5>
        <ul class="list-unstyled">
        <li>
            <a href="/marathon/docs/generated/api.html">REST API Reference</a>
        </li>

        <li><a href="/marathon/docs/rest-api.html">REST API Reference (deprecated)</a></li>

        </ul>
    </div>

    <div class="col-sm-9">
        <h1 id="blue-green-deployment">Blue-Green Deployment</h1>

<p>Blue-green deployment is a way to safely deploy applications that are serving live traffic by creating two versions of an application (BLUE and GREEN). To deploy a new version of the application, you will drain all traffic, requests, and pending operations from the current version of the application, switch to the new version, and then turn off the old version. Blue-green deployment eliminates application downtime and allows you to quickly roll back to the BLUE version of the application if necessary.</p>

<p>For an overview of the process, here&#39;s <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">a great article by Martin Fowler</a>.</p>

<p>In a production environment, you would typically script this process and integrate it into your existing deployment system. Below, we provide an example of the steps necessary to perform a safe deployment using the DC/OS CLI. (The DC/OS CLI works with both DC/OS and open source Marathon.)</p>

<h2 id="requirements">Requirements</h2>

<ul>
<li>A Marathon-based app with health checks that accurately reflect the health of the application.</li>
<li>The app must expose a metric endpoint to determine whether the app has any pending operations. For example, the application could expose a global atomic gauge of the number of currently queued DB transactions.</li>
<li>The <a href="https://stedolan.github.io/jq/">jq</a> command-line JSON processor. </li>
<li>If you are using open source Mesos, <a href="https://github.com/mesosphere/dcos-cli#using-the-cli-without-dcos">configure the DC/OS CLI</a>.</li>
</ul>

<h2 id="procedure">Procedure</h2>

<p>We will replace the current app version (BLUE) with a new version (GREEN).</p>

<ol>
<li><p>Launch the new version of the app on Marathon. Add a unique ID to the app name, such as the Git commit ID. In this example, we ID the new version of the app by adding <code>GREEN</code> to its name.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># launch green</span>
dcos marathon app add green-myapp.json
</code></pre></div>
<p><strong>Note:</strong> If you were using the API instead of the DC/OS CLI, the command above would be much longer:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d @green-myapp.json &lt;hosturl&gt;/marathon/v2/apps
</code></pre></div></li>
<li><p>Scale GREEN app instances by 1 or more. Initially (starting from 0 instances), set the number of app instances to the minimum required to serve traffic. Remember, no traffic will arrive yet: we haven&#39;t registered at the load balancer.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># scale green</span>
dcos marathon app update /green-myapp <span class="nv">instances</span><span class="o">=</span>1
</code></pre></div></li>
<li><p>Wait until all tasks from the GREEN app have passed health checks. This step requires <a href="https://stedolan.github.io/jq/">jq</a>.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># wait until healthy</span>
dcos marathon app show /green-myapp <span class="p">|</span> jq <span class="s1">&#39;.tasks[].healthCheckResults[] | select (.alive == false)&#39;</span>
</code></pre></div></li>
<li><p>Use the code snippet above to check that all instances of GREEN are still healthy. Abort the deployment and begin rollback if you see unexpected behavior.</p></li>
<li><p>Add the new task instances from the GREEN app to the load balancer pool.</p></li>
<li><p>Pick one or more task instances from the current (BLUE) version of the app.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># pick tasks from blue</span>
dcos marathon task list /blue-myapp
</code></pre></div></li>
<li><p>Update the load balancer configuration to remove the task instances above from the BLUE app pool.</p></li>
<li><p>Wait until the task instances from the BLUE app have 0 pending operations. Use the metrics endpoint in the application to determine the number of pending operations.</p></li>
<li><p>Once all operations are complete from the BLUE tasks, kill and scale the BLUE app using <a href="https://mesosphere.github.io/marathon/docs/rest-api.html#post-v2-tasks-delete">the API</a>. In the snippet below, <code>&lt;hosturl&gt;</code> is the hostname of your master node prefixed with <code>http://</code>.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># kill and scale blue tasks</span>
<span class="nb">echo</span> <span class="s2">&quot;{\&quot;ids\&quot;:[\&quot;&lt;task_id&gt;\&quot;]}&quot;</span> <span class="p">|</span> curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d @- &lt;hosturl&gt;/marathon/v2/tasks/delete?scale<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<p>This Marathon operation will remove specific instances (the ones with 0 pending operations) and prevent them from being restarted.</p></li>
<li><p>Repeat steps 2-9 until there are no more BLUE tasks.</p></li>
<li><p>Remove the BLUE app from Marathon.</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># remove blue</span>
dcos marathon app remove /blue-myapp
</code></pre></div></li>
</ol>

    </div>
</div>

          <footer>
            <p class="text-muted">
              &copy; 2016 <a class="text-muted" href="http://mesosphere.com">Mesosphere, Inc.</a>
            </p>
          </footer>
        </div>
      </div>
    </div>
    <script src="//cdn.jsdelivr.net/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>
</html>
