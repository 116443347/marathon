<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Marathon: Artifact Store</title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/marathon/css/style.css" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <a class="navbar-brand" href="/marathon/">Marathon</a>
              </div>
              <ul class="nav navbar-nav">
                <li><a href="/marathon/docs/">Docs</a></li>
              </ul>
              <ul class="nav navbar-nav navbar-right">
                <li><a href="https://github.com/mesosphere/marathon">GitHub</a></li>
              </ul>
            </div>
          </div>
          <div class="row">
  <div class="col-sm-3">
    <h5>Welcome</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/docs/">
          Getting Started
        </a>
      </li>
    </ul>
    <hr>
    <h5>Guides</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/docs/service-discovery-load-balancing.html">
          Discovery &amp; Load Balancing
        </a>
      </li>
    </ul>
    <hr>
    <h5>Reference</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/docs/artifact-store.html">
          Artifact Store
        </a>
      </li>
      <li>
        <a href="/marathon/docs/command-line-flags.html">
          Command Line Flags
        </a>
      </li>
      <li>
        <a href="/marathon/docs/constraints.html">
          Constraints
        </a>
      </li>
      <li>
        <a href="/marathon/docs/event-bus.html">
          Event Bus
        </a>
      </li>
      <li>
        <a href="/marathon/docs/health-checks.html">
          Health Checks
        </a>
      </li>
      <li>
        <a href="/marathon/docs/rest-api.html">
          REST API
        </a>
      </li>
    </ul>
    <hr>
    <h5>Resources</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/marathon/docs/deployment-design-doc.html">
          Deployment Design
        </a>
      </li>
    </ul>
  </div>
  <div class="col-sm-9">
    <h1 id="artifact-store">Artifact Store</h1>

<p>Deployments inside a distributed system need a location, where application specific resources can be found.
In Marathon we call this place the artifact store.</p>

<h2 id="usage">Usage</h2>

<p>The use of the Marathon Artifact Store functionality is completely optional.
All functionality and goals can be accomplished manually as well.
Marathon tries to simplify several use cases.</p>

<h2 id="artifact-store-backend">Artifact Store Backend</h2>

<p>Marathon supports different storage system, that can be used as artifact store.
The type of the artifact store is configured via the command line.
Example: start with --artifact_store hdfs://localhost:54310/path/to/store to use Hadoop DFS 
as artifact storage backend.</p>

<h2 id="artifact-rest-endpoint">Artifact REST endpoint</h2>

<p>There is a special endpoint to access and manipulate the artifacts in the artifact store.
The URL&#39;s of the created artifacts can be used as URI&#39;s of an application definition.</p>

<h3 id="upload-an-artifact-to-the-artifact-store">Upload an artifact to the artifact store</h3>

<p>Upload an artifact to the artifact store.
A multipart form upload request has to be performed.
The form parameter name has to be <code>file</code>.
The filename used in the artifact store, is the same as given by the form parameter.
The response holds the URL of the artifact in the artifact store in the Location Header.</p>

<p><strong>Request:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">POST</span> <span class="nn">/v2/artifacts</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">158</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=f1902a5119af474791bc48395048a8f2</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">HTTPie/0.8.0</span>

--f1902a5119af474791bc48395048a8f2
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;test.txt&quot;

...Content of the file...

--f1902a5119af474791bc48395048a8f2--</code></pre></div>

<p><strong>Response:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">0</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">hdfs://hd.cluster.bare.org:54310/artifact/test.txt</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">Jetty(8.1.11.v20130520)</span></code></pre></div>

<p>If you want to specify a specific path in the artifact store, specify the path in the url:</p>

<p><strong>Request:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">POST</span> <span class="nn">/v2/artifacts/special/file/name.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">158</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=d6f4e71fe7db4197bc2a4f5666e65917</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">HTTPie/0.8.0</span>

--d6f4e71fe7db4197bc2a4f5666e65917
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;test.txt&quot;

...Content of the file...

--d6f4e71fe7db4197bc2a4f5666e65917--</code></pre></div>

<p><strong>Response:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">0</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">hdfs://localhost:54310/artifact/special/file/name.txt</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">Jetty(8.1.11.v20130520)</span></code></pre></div>

<h3 id="get-an-artifact-from-the-artifact-store">Get an artifact from the artifact store</h3>

<p>The path is the relative path in the artifact store.</p>

<p><strong>Request:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/v2/artifacts/special/file/name.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">HTTPie/0.8.0</span></code></pre></div>

<p><strong>Response:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">14</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain</span>
<span class="na">Last-Modified</span><span class="o">:</span> <span class="l">Tue, 22 Jul 2014 11:52:23 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">Jetty(8.1.11.v20130520)</span>

...Content of the file...</code></pre></div>

<h3 id="delete-an-artifact-from-the-artifact-store">Delete an artifact from the artifact store</h3>

<p>The path is the relative path in the artifact store.</p>

<p><strong>Request:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">DELETE</span> <span class="nn">/v2/artifacts/special/file/name.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">0</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">HTTPie/0.8.0</span></code></pre></div>

<p><strong>Response:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">Jetty(8.1.11.v20130520)</span></code></pre></div>

<h2 id="automatic-artifact-storing">Automatic Artifact Storing</h2>

<p>An AppDefinition holds a sequence of URIs, that get fetched on each instance, that gets started.
The artifact could be fetched directly from the source, or put into the artifact store.
One simple way to do this is automatic artifact storing.</p>

<p>The AppDefinition has a field storeUrls, which holds an array of URL strings.
Every URL here is processed in this way:</p>

<ul>
<li>The URL gets downloaded</li>
<li>The byte stream is stored in the asset store</li>
<li>The asset store url is added to the AppDefinition uris list</li>
<li>The url is removed from the storeUrls array</li>
</ul>

<p>As a result, all storeUrls are accessible from the artifact store.
All instances that will run the application, will load the needed assets from the artifact store.</p>

<h3 id="create-an-application-definition-with-automatic-artifact-resolution">Create an application definition with automatic artifact resolution</h3>

<p><strong>Request:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">POST</span> <span class="nn">/v2/apps</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">197</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json; charset=utf-8</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">HTTPie/0.8.0</span>

<span class="p">{</span>
    <span class="nt">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;python toggle.py $PORT0&quot;</span><span class="p">,</span> 
    <span class="nt">&quot;cpus&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> 
    <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> 
    <span class="nt">&quot;mem&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> 
    <span class="nt">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="mi">0</span>
    <span class="p">],</span> 
    <span class="nt">&quot;storeUrls&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;http://downloads.mesosphere.io/misc/toggle.tgz&quot;</span>
    <span class="p">]</span>
<span class="p">}</span></code></pre></div>

<p><strong>Response</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:8080/v2/apps/mongo2</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">Jetty(8.1.11.v20130520)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;deploymentId&quot;</span><span class="p">:</span> <span class="s2">&quot;910ae97f-3f3d-4fdb-a9a1-9d72f0ae8e49&quot;</span><span class="p">,</span> 
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2014-07-22T13:25:52.319Z&quot;</span>
<span class="p">}</span></code></pre></div>

<p>When the app gets deployed, all storeUrls will be stored in the artifact store and
the definition will be adapted and will look like this:</p>

<p><strong>Request:</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="nf">GET</span> <span class="nn">/v2/apps/app</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8080</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">HTTPie/0.8.0</span></code></pre></div>

<p><strong>Response</strong></p>

<div class="highlight"><pre><code class="language-http" data-lang="http"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">Jetty(8.1.11.v20130520)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;app&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;cmd&quot;</span><span class="p">:</span> <span class="s2">&quot;python toggle.py $PORT0 mongo2 v1&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;cpus&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> 
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;/app&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> 
        <span class="nt">&quot;mem&quot;</span><span class="p">:</span> <span class="mf">32.0</span><span class="p">,</span> 
        <span class="nt">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="mi">10001</span>
        <span class="p">],</span> 
        <span class="nt">&quot;storeUrls&quot;</span><span class="p">:</span> <span class="p">[],</span> 
        <span class="nt">&quot;uris&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;hdfs://localhost:54310/artifact/f1cc046e4b603a94d0932eb818854fcc52e1b563/toggle.tgz&quot;</span>
        <span class="p">]</span> 
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<h3 id="automatic-path-creation">Automatic Path creation</h3>

<p>The path in the asset store is computed that way:</p>

<ul>
<li>HEAD Request to the asset</li>
<li>if ETag is available, take ETag HTTP Header</li>
<li>if ETag is not available (dumb HTTP server), download the resource and compute the Sha-1 hash manually</li>
<li>filename of the url remains the same</li>
</ul>

<p>The complete path is {artifact store base}/{ETag or ContentHash}/{filename of asset}
This effectively will create a path, that is unique to the content of the resource.
If the same URL holds a different entity, a new path is created.
The same path is downloaded only once. 
In other words if the path is available in the artifact store, it is not downloaded again.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>To use this feature, all assets need to be resolvable by marathon itself.
To circumvent manual content hash creation, the http server should support HTTP ETag Header. </p>

  </div>
</div>

          <footer>
            <p class="text-muted">
              &copy; 2014 <a class="text-muted" href="http://mesosphere.io">Mesosphere, Inc.</a>
            </p>
          </footer>
        </div>
      </div>
    </div>
  </body>
</html>
